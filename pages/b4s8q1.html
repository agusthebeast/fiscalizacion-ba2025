<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cargar Escrutinio</title>
  <link rel="stylesheet" href="../css/jIh3aOq.css" />
  <link rel="icon" type="image/x-icon" href="../favicon.ico" />
</head>
<body>
  <div class="login-container">
    <button onclick="location.href='a8Lp3Nw.html'" style="margin-bottom: 15px;">← Volver al menú</button>

    <h2>Cargar Escrutinio</h2>

    <label for="mesa">Seleccioná tu mesa:</label>
    <select id="mesa"></select>

    <label>A. Electores que votaron:</label>
    <input type="number" id="votaron" />

    <label>B. Sobres en la urna:</label>
    <input type="number" id="sobres" oninput="calcularDiferencia()" />

    <label>C. Diferencia A - B:</label>
    <input type="number" id="diferencia" disabled />

    <table border="1" style="width:100%; margin-top:20px;">
      <thead>
        <tr>
          <th>Partido</th>
          <th>Diputados</th>
          <th>Concejales</th>
        </tr>
      </thead>
      <tbody id="tabla-votos"></tbody>
    </table>

    <label>D. Votos en blanco:</label>
    <input type="number" id="blanco" />

    <label>E. Votos impugnados:</label>
    <input type="number" id="impugnados" />

    <label>Foto del acta:</label>
    <input type="file" id="foto" accept="image/*" />

    <button id="btn-guardar" onclick="guardarEscrutinio()">Guardar</button>
    <div id="estado"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-auth-compat.js"></script>
  <script src="../js/x2BkaL9e.js"></script>

  <script>
    const agrupaciones = [
      { codigo: "2200", nombre: "FUERZA PATRIA" },
      { codigo: "2201", nombre: "POTENCIA" },
      { codigo: "2202", nombre: "ES CON VOS ES CON NOSOTROS", noUsar: true },
      { codigo: "2203", nombre: "FTE DE IZQ. Y DE TRABAJADORES - UNIDAD" },
      { codigo: "2204", nombre: "SOMOS BUENOS AIRES" },
      { codigo: "2205", nombre: "NUEVOS AIRES" },
      { codigo: "2206", nombre: "LA LIBERTAD AVANZA" },
      { codigo: "2207", nombre: "UNION Y LIBERTAD" },
      { codigo: "2208", nombre: "UNION LIBERAL" },
      { codigo: "959", nombre: "MOVIMIENTO AVANZADA SOCIALISTA", noUsar: true },
      { codigo: "963", nombre: "FRENTE PATRIOTA FEDERAL", noUsar: true },
      { codigo: "974", nombre: "POLITICA OBRERA", noUsar: true },
      { codigo: "980", nombre: "PARTIDO TIEMPO DE TODOS", noUsar: true },
      { codigo: "1003", nombre: "CONSTRUYENDO PORVENIR", noUsar: true },
      { codigo: "1006", nombre: "PARTIDO LIBERTARIO" },
      { codigo: "1008", nombre: "VALORES REPUBLICANOS" }
    ];

    const db = firebase.firestore();
    let dniUsuario = "";
    let escuela = "";

    function calcularDiferencia() {
      const a = parseInt(document.getElementById("votaron").value) || 0;
      const b = parseInt(document.getElementById("sobres").value) || 0;
      document.getElementById("diferencia").value = a - b;
    }

    firebase.auth().onAuthStateChanged(user => {
      if (!user) return;
      dniUsuario = user.email.split("@")[0];

      db.collection("mesas").where("fiscal_dni", "==", dniUsuario).orderBy("mesa").get()
        .then(snapshot => {
          const select = document.getElementById("mesa");
          select.innerHTML = `<option value="">-- Elegir mesa --</option>`;
          snapshot.forEach(doc => {
            const data = doc.data();
            escuela = data.escuela;
            select.innerHTML += `<option value="${data.mesa}">Mesa ${data.mesa}</option>`;
          });
        });

      const tabla = document.getElementById("tabla-votos");
      agrupaciones.forEach(a => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${a.codigo} - ${a.nombre}</td>
          <td><input type="number" id="dip_${a.codigo}" value="0" /></td>
          <td><input type="number" id="con_${a.codigo}" value="0" ${a.noUsar ? "disabled" : ""} /></td>
        `;
        tabla.appendChild(fila);
      });
    });

    async function guardarEscrutinio() {
      const btn = document.getElementById("btn-guardar");
      btn.disabled = true;
      btn.innerText = "Guardando...";

      const mesa = document.getElementById("mesa").value;
      if (!mesa) {
        alert("Elegí una mesa");
        btn.disabled = false;
        btn.innerText = "Guardar";
        return;
      }

      const archivo = document.getElementById("foto").files[0];
      if (!archivo) {
        alert("Subí la foto del acta");
        btn.disabled = false;
        btn.innerText = "Guardar";
        return;
      }

      // Verificar si la mesa ya fue cargada
      const docRef = db.collection("escrutinios").doc(mesa);
      const existente = await docRef.get();
      if (existente.exists) {
        const confirmar = confirm("⚠️ Esta mesa ya fue cargada. ¿Querés reemplazar los datos?");
        if (!confirmar) {
          document.getElementById("estado").innerText = "Cancelado por el usuario.";
          btn.disabled = false;
          btn.innerText = "Guardar";
          return;
        }
      }

      const votos = {};
      agrupaciones.forEach(a => {
        votos[a.codigo + " - " + a.nombre] = {
          diputados: parseInt(document.getElementById("dip_" + a.codigo).value) || 0,
          concejales: a.noUsar ? 0 : parseInt(document.getElementById("con_" + a.codigo).value) || 0
        };
      });

      const resumen = {
        mesa,
        dni: dniUsuario,
        escuela,
        votos,
        votos_en_blanco: parseInt(document.getElementById("blanco").value) || 0,
        votos_impugnados: parseInt(document.getElementById("impugnados").value) || 0,
        electores_que_votaron: parseInt(document.getElementById("votaron").value) || 0,
        sobres_en_urna: parseInt(document.getElementById("sobres").value) || 0,
        timestamp: Date.now()
      };

      // Cloudinary con timestamp
      document.getElementById("estado").innerText = "Subiendo foto...";
      const fecha = new Date().toISOString().replace(/[:.]/g, "-");
      const nombreImg = `${mesa}-${fecha}`;

      const formData = new FormData();
      formData.append("file", archivo);
      formData.append("upload_preset", "escrutinio");
      formData.append("folder", `escrutinios/${dniUsuario}`);
      formData.append("public_id", `escrutinios/${dniUsuario}/${nombreImg}`);

      const res = await fetch("https://api.cloudinary.com/v1_1/dudrnu2mq/image/upload", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      resumen.urlFoto = data.secure_url;

      // Guardar historial de fotos anteriores si las hay
      resumen.fotos_anteriores = existente.exists && existente.data().urlFoto
        ? [...(existente.data().fotos_anteriores || []), existente.data().urlFoto]
        : [];

      document.getElementById("estado").innerText = "Guardando en base de datos...";
      await docRef.set(resumen);

      // Mostrar popup de éxito
      document.getElementById("popup-ok").style.display = "block";
    }

    function cerrarPopup() {
      document.getElementById("popup-ok").style.display = "none";
      location.href = "../pages/a8Lp3Nw.html"; // Cambia si tu menú tiene otro nombre
    }
  </script>

  <!-- ✅ Cartel visual de confirmación -->
  <div id="popup-ok" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; text-align:center; padding:40px;">
    <img src="../favicon.ico" style="width:60px; margin-bottom:20px;" />
    <h2 style="color:#4c2882;">Gracias por tu aporte,<br>la provincia necesita abrir los ojos</h2>
    <button onclick="cerrarPopup()" style="background:#4c2882; color:white; padding:10px 20px; font-size:16px; border:none; border-radius:8px; margin-top:20px;">Cerrar</button>
  </div>

</body>
</html>
