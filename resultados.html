<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resultados</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <main>
    <h1>Consulta de Resultados</h1>

    <label for="buscador">Buscar por distrito o mesa:</label>
    <input type="text" id="buscador" placeholder="Ej: Avellaneda o 1245" />

    <div id="resultados-container"></div>
  </main>

  <script type="module">
    import { auth, db } from './js/firebase.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import {
      collectionGroup, getDocs, query
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    onAuthStateChanged(auth, async (user) => {
      if (!user) location.href = 'index.html';

      const q = query(collectionGroup(db, "mesas"));
      const snapshot = await getDocs(q);
      const data = [];

      snapshot.forEach(docSnap => {
        const datos = docSnap.data();
        data.push({
          id: docSnap.id,
          distrito: docSnap.ref.parent.parent.id,
          listas: datos.listas,
          imagen: datos.imagenActa || null
        });
      });

      const contenedor = document.getElementById("resultados-container");

      function renderizar(filtro = "") {
        contenedor.innerHTML = "";
        data
          .filter(d => {
            return d.distrito.toLowerCase().includes(filtro.toLowerCase()) ||
                   d.id.includes(filtro);
          })
          .forEach(d => {
            const div = document.createElement("div");
            div.className = "resultado";
            div.innerHTML = `
              <h3>Mesa ${d.id} - ${d.distrito}</h3>
              <ul>
                ${Object.entries(d.listas).map(([nombre, votos]) =>
                  `<li>${nombre}: Gobernador ${votos.gobernador}, Diputados ${votos.diputados}</li>`
                ).join("")}
              </ul>
              ${d.imagen ? `<a href="${d.imagen}" target="_blank">Ver acta</a>` : ''}
              <hr>
            `;
            contenedor.appendChild(div);
          });
      }

      renderizar();

      document.getElementById("buscador").addEventListener("input", (e) => {
        renderizar(e.target.value);
      });
    });
  </script>
</body>
</html>
